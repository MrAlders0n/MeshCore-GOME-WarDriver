<!DOCTYPE html>
<html lang="en">

<head>
  <title>Add Repeater</title>
  <link rel="stylesheet" type="text/css" href="content/forms.css" />
</head>

<body>
  <div>
    <div class="form-item">
      <label for="id">Id:</label>
      <input type="text" id="id" name="id">
    </div>
    <div class="form-item">
      <label for="name">Name:</label>
      <input type="text" id="name" name="name">
    </div>
    <div class="form-item">
      <label for="lat">Lat:</label>
      <input type="text" id="lat" name="lat">
    </div>
    <div class="form-item">
      <label for="lon">Lon:</label>
      <input type="text" id="lon" name="lon">
    </div>
    <div class="form-item">
      <label for="path">Path:</label>
      <input type="text" id="path" name="path">
    </div>
    <div class="form-item">
      <button tabindex="0" id="submit" name="submit" onclick="putRepeater()">Submit</button>
    </div>
  </div>
  <div id="status">
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const idTxt = $('id');
    const nameTxt = $('name');
    const latTxt = $('lat');
    const lonTxt = $('lon');
    const pathTxt = $('path');
    const statusDiv = $('status');

    function setStatus(msg) {
      msg = msg ?? "";
      statusDiv.innerText = msg
      if (msg !== "") {
        setTimeout(setStatus, 3000);
      }
    }

    function clearForm() {
      idTxt.value = '';
      nameTxt.value = '';
      latTxt.value = '';
      lonTxt.value = '';
      pathTxt.value = '';
    }

    async function putRepeater() {
      const idVal = idTxt.value;
      const nameVal = nameTxt.value;
      const latVal = latTxt.value;
      const lonVal = lonTxt.value;
      const pathVal = pathTxt.value;
      const payload = {
        id: idVal,
        name: nameVal,
        lat: parseFloat(latVal),
        lon: parseFloat(lonVal),
        path: pathVal !== "" ? pathVal.split(',') : []
      };

      if (isNaN(payload.lat) || isNaN(payload.lon)) {
        setStatus("Invalid position");
        return;
      }

      if (idVal.length !== 2) {
        setStatus("Invalid id");
        return;
      }

      console.log(`putting ${payload}`);
      setStatus('');

      const resp = await fetch('/put-repeater', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        setStatus('HTTP error ' + resp.status);
      } else {
        setStatus('Repeater saved!');
        clearForm();
      }
    }
  </script>
</body>

</html>
