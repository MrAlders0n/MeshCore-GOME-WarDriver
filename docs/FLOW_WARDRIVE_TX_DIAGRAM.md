# TX WARDRIVING FLOW

```diagram
    ┌─────────────────────────┐
    │         TRIGGER         │
    │  ─────────────────────  │
    │  User clicks "Send Ping"│
    │  OR Auto Timer Fires    │
    └────────────┬────────────┘
                 │
                 ▼
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║                              VALIDATION PHASE                             ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║                                                                           ║
    ║     ┌──────────────────────────┐                                          ║
    ║     │ Cooldown Active?         │                                          ║
    ║     │ (7s after last ping)     │                                          ║
    ║     └─────────┬────────────────┘                                          ║
    ║               │                                                           ║
    ║       ┌───────┴───────┐                                                   ║
    ║       │               │                                                   ║
    ║      YES              NO                                                  ║
    ║       │               │                                                   ║
    ║       ▼               ▼                                                   ║
    ║  ┌─────────────┐  ┌──────────────────────────┐                            ║
    ║  │    BLOCK    │  │  Get GPS Position        │                            ║
    ║  │ Show warning│  │ (lat, lon, accuracy)     │                            ║
    ║  │ "Wait Xs"   │  └─────────┬────────────────┘                            ║
    ║  └─────────────┘            │                                             ║
    ║                             ▼                                             ║
    ║                 ┌──────────────────────────┐                              ║
    ║                 │ VALIDATION 1: Geofence   │                              ║
    ║                 │ Within 150km of Ottawa?  │                              ║
    ║                 └─────────┬────────────────┘                              ║
    ║                           │                                               ║
    ║                   ┌───────┴───────┐                                       ║
    ║                  NO              YES                                      ║
    ║                   │               │                                       ║
    ║                   ▼               ▼                                       ║
    ║  ┌─────────────────────┐  ┌──────────────────────────┐                    ║
    ║  │    SKIP PING        │  │ VALIDATION 2: Distance   │                    ║
    ║  │ reason: "outside    │  │ ≥25m from last ping?     │                    ║
    ║  │ geofence"           │  └─────────┬────────────────┘                    ║
    ║  └─────────────────────┘            │                                     ║
    ║                             ┌───────┴───────┐                             ║
    ║                            NO              YES                            ║
    ║                             │               │                             ║
    ║                             ▼               ▼                             ║
    ║            ┌─────────────────────┐  ┌─────────────────┐                   ║
    ║            │    SKIP PING        │  │  VALIDATIONS    │                   ║
    ║            │ reason: "too close" │  │    PASSED       │                   ║
    ║            └─────────────────────┘  └────────┬────────┘                   ║
    ║                                              │                            ║
    ╚══════════════════════════════════════════════╪════════════════════════════╝
                                                   │
                                                   ▼
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║                              BUILD PAYLOAD                                ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║                                                                           ║
    ║     Build Message:  "@[MapperBot] 45. 42150, -75.69720 [0. 6w]"           ║
    ║                                                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
                                                   │
                                                   ▼
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║                              TRANSMIT TO MESH                             ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║                                                                           ║
    ║  ┌────────────────────────────────────────────────────────────────────┐   ║
    ║  │  1. Start Repeater Echo Tracking                                   │   ║
    ║  │     • Initialize rx_log listener                                   │   ║
    ║  │     • Clear repeaters Map                                          │   ║
    ║  │     • Uses pre-computed WARDRIVING_CHANNEL_HASH for correlation    │   ║
    ║  └────────────────────────────────────────────────────────────────────┘   ║
    ║                                      │                                    ║
    ║                                      ▼                                    ║
    ║  ┌────────────────────────────────────────────────────────────────────┐   ║
    ║  │  2. SEND TO MESH                                                   │   ║
    ║  │     connection.sendChannelTextMessage(channelIdx, payload)         │   ║
    ║  │                                                                    │   ║
    ║  │     ──────────► #wardriving channel ──────────► Mesh Network       │   ║
    ║  └────────────────────────────────────────────────────────────────────┘   ║
    ║                                      │                                    ║
    ║                                      ▼                                    ║
    ║  ┌────────────────────────────────────────────────────────────────────┐   ║
    ║  │  3. Update UI & State                                              │   ║
    ║  │     • Status: "Ping sent" ✓                                        │   ║
    ║  │     • Start 7s cooldown                                            │   ║
    ║  │     • Log to Session (with placeholder "...")                      │   ║
    ║  │     • Lock ping controls (pingInProgress = true)                   │   ║
    ║  │     • Store currentLogEntry for incremental updates                │   ║
    ║  └────────────────────────────────────────────────────────────────────┘   ║
    ║                                                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
                                                   │
                                                   ▼
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║                        RX LISTENING WINDOW (6 seconds)                    ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║                                                                           ║
    ║     UI Status: "Listening for heard repeats (6s)" → (5s) → (4s) → ...     ║
    ║                                                                           ║
    ║     ┌─────────────────────────────────────────────────────────────────┐   ║
    ║     │          TX LOG HANDLER (Echo Detection)                   │   ║
    ║     │          *** STRICT VALIDATION (PR #130) ***                  │   ║
    ║     ├─────────────────────────────────────────────────────────────────┤   ║
    ║     │                                                                 │   ║
    ║     │   STEP 1: Header = CHANNEL_GROUP_TEXT_HEADER (0x15)?            │   ║
    ║     │           └── NO → Return false (not an echo)                   │   ║
    ║     │                                                                 │   ║
    ║     │   STEP 2: Channel hash matches WARDRIVING_CHANNEL_HASH?         │   ║
    ║     │           └── NO → Return false (different channel)             │   ║
    ║     │                                                                 │   ║
    ║     │   STEP 3: Decrypt & verify message matches our sentPayload?     │   ║
    ║     │           └── NO → Return false (not our ping)                  │   ║
    ║     │                                                                 │   ║
    ║     │   STEP 4: Path length > 0?  (has repeater hop)                  │   ║
    ║     │           └── NO → Return false (direct TX)                     │   ║
    ║     │                                                                 │   ║
    ║     │      ALL PASSED → Track echo, extract FIRST hop repeater ID     │   ║
    ║     │                                                                 │   ║
    ║     │   ┌──────────┐ ┌──────────┐ ┌──────────┐                        │   ║
    ║     │   │ 22       │ │ 4e       │ │ b7       │  ◄── Live UI Updates   │   ║
    ║     │   │ 11. 5 dB  │ │ 8.25 dB │ │ -2.0 dB  │                        │   ║
    ║     │   │ (green)  │ │ (green)  │ │ (red)    │                        │   ║
    ║     │   └──────────┘ └──────────┘ └──────────┘                        │   ║
    ║     │                                                                 │   ║
    ║     └─────────────────────────────────────────────────────────────────┘   ║
    ║                                                                           ║
    ║     After 6 seconds:  Finalize "22(11.5),4e(8.25),b7(-2.0)"               ║
    ║                                                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
                                                   │
                                                   ▼
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║                       FINALIZE & BACKGROUND API POST                      ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║                                                                           ║
    ║  ┌────────────────────────────────────────────────────────────────────┐   ║
    ║  │  1. Update TX Log Entry with Heard Repeaters                  │   ║
    ║  │     "..." ──► "22(11.5),4e(8.25),b7(-2.0)"                         │   ║
    ║  └────────────────────────────────────────────────────────────────────┘   ║
    ║                                      │                                    ║
    ║                                      ▼                                    ║
    ║  ┌────────────────────────────────────────────────────────────────────┐   ║
    ║  │  2. IMMEDIATELY:  Update UI & Schedule Next                        │   ║
    ║  │     • If auto mode: schedule next ping OR resume paused countdown  │   ║
    ║  │     • If manual mode: set status to "Idle"                         │   ║
    ║  │     • Unlock ping controls (pingInProgress = false)                │   ║
    ║  │                                                                    │   ║
    ║  │    *** KEY:  Don't wait for API - UI is responsive immediately *** │   ║
    ║  └────────────────────────────────────────────────────────────────────┘   ║
    ║                                      │                                    ║
    ║                                      ▼                                    ║
    ║  ┌────────────────────────────────────────────────────────────────────┐   ║
    ║  │  3. BACKGROUND:  API Post (postApiInBackground)                    │   ║
    ║  │     ┌──────────────────────────────────────────────────────────┐   │   ║
    ║  │     │     Hidden 3-second delay (no status message)            │   │   ║
    ║  │     └──────────────────────────────────────────────────────────┘   │   ║
    ║  │                               │                                    │   ║
    ║  │                               ▼                                    │   ║
    ║  │     ┌──────────────────────────────────────────────────────────┐   │   ║
    ║  │     │     POST to UNIFIED MeshMapper API                       │   │   ║
    ║  │     │  https://yow.meshmapper.net/wardriving-api. php          │   │   ║
    ║  │     │                                                          │   │   ║
    ║  │     │  {                                                       │   │   ║
    ║  │     │    "key": "API_KEY",                                     │   │   ║
    ║  │     │    "lat": 45.42150,                                      │   │   ║
    ║  │     │    "lon": -75.69720,                                     │   │   ║
    ║  │     │    "who": "DeviceName",                                  │   │   ║
    ║  │     │    "power": "0.6w",                                      │   │   ║
    ║  │     │    "heard_repeats": "22(11.5),4e(8.25),b7(-2.0)",        │   │   ║
    ║  │     │    "ver": "DEV-1703257800",                              │   │   ║
    ║  │     │    "session_id": "abc123",                               │   │   ║
    ║  │     │    "iata": "YOW",                                        │   │   ║
    ║  │     │    "test": 0,                                            │   │   ║
    ║  │     │    "WARDRIVE_TYPE": "TX"                                 │   │   ║
    ║  │     │  }                                                       │   │   ║
    ║  │     └──────────────────────────────────────────────────────────┘   │   ║
    ║  │                               │                                    │   ║
    ║  │                               ▼                                    │   ║
    ║  │     Check response for slot revocation (allowed:  false)           │   ║
    ║  │     If revoked ──► disconnect with reason "slot_revoked"           │   ║
    ║  │                                                                    │   ║
    ║  └────────────────────────────────────────────────────────────────────┘   ║
    ║                                                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
```